<!-- <!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Image For Time</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #fff;
        }

        div {
            text-align: center;
        }

        .image-item {
            width: 100%;
            object-fit: cover;
            margin: 10px;
            border-radius: 8px;
        }

        .container {
            column-count: 5;
            /* Số cột bạn muốn */
            column-gap: 16px;
            margin-top: 20px;

            justify-content: center;
            align-items: center;
        }

        ul {
            list-style-type: none;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            flex-direction: row;
        }

        .pagination-item {
            margin: 0 5px;
        }

        .page_number {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: row;
        }

        .page_item {
            margin: 0 5px;
        }

        .input-form {
            margin: 10px;
            padding: 8px;
            width: 200px;
        }

        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        .input-form {
            margin: 10px;
            padding: 8px;
            width: 200px;
        }

        a {
            text-decoration: none;
        }

        .image-process-container {
            margin-top: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
            align-items: center;
            justify-content: center;
        }

        #zip-block {
            margin-top: 18px;
            padding: 12px 20px;
            background: #f8f9fa;
            border-radius: 6px;
            color: #333;
            font-size: 1.1rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            text-align: center;
            min-height: 32px;
            transition: background 0.2s;
        }

        @media (max-width: 1200px) {
            .container {
                column-count: 3;
            }
        }

        /* Responsive cho mobile */
        @media (max-width: 768px) {
            .container {
                column-count: 2;
            }
        }

        @media (max-width: 480px) {
            .container {
                column-count: 1;
            }
        }
    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

</head>

<body>
    <div>
        <h1>Image For ZIP</h1>
        <div id="current-page"></div>
        <form id="time-form">
            <label for="start_time">Start Time:</label>
            <input type="datetime-local" id="start_time" name="start_time" required class="input-form">
            <br>
            <label for="end_time">End Time:</label>
            <input type="datetime-local" id="end_time" name="end_time" required class="input-form">
            <br>
            <button type="submit">Submit</button>
        </form>
        <p id="zip-block"></p>
        <div class="container">

            <div id="image-process-container">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="25" aria-valuemin="0"
                        aria-valuemax="100">0</div>
                </div>
            </div>
        </div>
        <script src='../static/script_zip.js'></script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    </div>
</body>

</html> -->

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Tải Ảnh Theo Khoảng Thời Gian</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <!-- NOTE: Thêm Google Fonts để có font chữ đẹp hơn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- NOTE: Sử dụng Bootstrap 5 để có các component và class tiện ích mới nhất -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- NOTE: Thêm icon của Bootstrap để làm icon loading cho nút bấm -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">


    <style>
        /* NOTE: Sử dụng biến CSS để quản lý màu sắc, dễ dàng thay đổi theme sau này */
        :root {
            --primary-color: #0d6efd;
            --light-gray: #f8f9fa;
            --dark-gray: #6c757d;
            --text-color: #212529;
            --background-color: #e9ecef;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 0.5rem;
        }

        /* NOTE: Thiết lập style chung cho body, đẹp và dễ đọc hơn */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        /* NOTE: Tạo một card chính để chứa toàn bộ nội dung, tạo sự tập trung */
        .main-card {
            background-color: #fff;
            padding: 2rem 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        
        /* NOTE: Style cho tiêu đề */
        h1 {
            color: var(--text-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        /* NOTE: Căn chỉnh lại form cho đẹp hơn */
        #time-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* NOTE: Style cho các input field */
        .form-control {
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            border: 1px solid #ced4da;
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25);
        }

        /* NOTE: Style cho nút bấm chính, có hiệu ứng hover */
        .btn-primary {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            font-size: 1rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
        }

        /* NOTE: Style cho khu vực hiển thị trạng thái và tiến trình */
        #status-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
        }

        #status-message {
            font-size: 1.1rem;
            color: var(--dark-gray);
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        /* NOTE: Tùy chỉnh thanh progress bar */
        .progress {
            height: 1.25rem;
            font-size: 0.85rem;
            border-radius: var(--border-radius);
        }

        .progress-bar {
            font-weight: 500;
        }

        /* NOTE: Style cho nút tải về, nổi bật hơn */
        #download-zip-btn {
            font-weight: 600;
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <!-- NOTE: Bọc toàn bộ nội dung trong một card để dễ dàng style và căn giữa -->
    <div class="main-card">
        <h1>Tải Ảnh ZIP</h1>
        <p class="text-muted mb-4">Chọn khoảng thời gian bắt đầu và kết thúc để tạo file ZIP chứa hình ảnh.</p>

        <!-- NOTE: Sử dụng các class của Bootstrap 5 để tạo form đẹp hơn mà không cần nhiều CSS tùy chỉnh -->
        <form id="time-form">
            <div class="form-group text-start">
                <label for="start_time" class="form-label fw-medium">Thời gian bắt đầu:</label>
                <input type="datetime-local" id="start_time" name="start_time" required class="form-control">
            </div>

            <div class="form-group text-start">
                <label for="end_time" class="form-label fw-medium">Thời gian kết thúc:</label>
                <input type="datetime-local" id="end_time" name="end_time" required class="form-control">
            </div>

            <!-- NOTE: Thêm span cho text và icon loading, dễ dàng chuyển đổi trạng thái bằng JS -->
            <button type="submit" id="submit-btn" class="btn btn-primary w-100 mt-3">
                <span class="btn-text">Tạo File ZIP</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
        </form>

        <!-- NOTE:
            - Tạo sẵn khu vực hiển thị trạng thái, tiến trình và nút tải về.
            - Dùng class 'd-none' của Bootstrap để ẩn đi ban đầu.
            - JS sẽ chỉ cần hiện/ẩn và cập nhật nội dung thay vì tạo mới phần tử.
        -->
        <div id="status-container" class="d-none">
            <p id="status-message">Đang khởi tạo...</p>
            <div class="progress">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <a href="#" id="download-zip-btn" class="btn btn-success d-none" download>
                <i class="bi bi-download me-2"></i> Tải File ZIP
            </a>
        </div>
    </div>


    <script>
        // NOTE: Lấy tất cả các phần tử cần thao tác ra biến để dễ quản lý
        const form = document.getElementById("time-form");
        const submitBtn = document.getElementById("submit-btn");
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.spinner-border');

        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const downloadBtn = document.getElementById('download-zip-btn');


        form.addEventListener('submit', (e) => {
            e.preventDefault();

            // NOTE: Lấy giá trị từ form
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;

            // NOTE: Cập nhật giao diện khi bắt đầu xử lý
            // 1. Vô hiệu hóa nút bấm và hiển thị spinner
            submitBtn.disabled = true;
            btnText.textContent = "Đang xử lý...";
            btnSpinner.classList.remove('d-none');

            // 2. Hiển thị khu vực trạng thái và reset lại trạng thái cũ (nếu có)
            statusContainer.classList.remove('d-none');
            statusMessage.textContent = "Chúng tôi đang xử lý, vui lòng chờ...";
            statusMessage.className = 'text-primary'; // Đổi màu chữ
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.classList.add('progress-bar-animated'); // Thêm lại hiệu ứng animation
            downloadBtn.classList.add('d-none'); // Ẩn nút download cũ đi

            fetch('http://127.0.0.1:8000/api/down/chord_image_gevent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    "start_time": startTime,
                    "end_time": endTime
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Lỗi mạng hoặc server không phản hồi.');
                }
                return response.json();
            })
            .then(data => {
                const task_id = data.task_id;
                // NOTE: Bắt đầu quá trình "polling" để kiểm tra trạng thái
                pollStatus(task_id);
            })
            .catch(error => {
                // NOTE: Xử lý lỗi ngay từ lần gọi API đầu tiên
                console.error("Lỗi khi gửi yêu cầu:", error);
                statusMessage.textContent = `Có lỗi xảy ra: ${error.message}`;
                statusMessage.className = 'text-danger';
                // NOTE: Kích hoạt lại nút bấm khi có lỗi
                resetButtonState();
            });
        });
        
        // NOTE: Hàm Polling để lấy trạng thái tác vụ
        function pollStatus(taskId) {
            fetch(`http://127.0.0.1:8000/api/down/chord_status_gevent/${taskId}`)
                .then(response => response.json())
                .then(statusData => {
                    switch (statusData.status) {
                        case "PENDING":
                            statusMessage.textContent = "Đang thu thập và nén hình ảnh...";
                            // Cập nhật thanh tiến trình
                            const percent = Math.round(statusData.progress || 0);
                            progressBar.style.width = percent + "%";
                            progressBar.textContent = percent + "%";
                            // Gọi lại hàm sau 1 giây
                            setTimeout(() => pollStatus(taskId), 1000);
                            break;

                        case "SUCCESS":
                            statusMessage.textContent = "Tạo file ZIP thành công!";
                            statusMessage.className = 'text-success fw-bold';
                            // Hoàn thành progress bar
                            progressBar.style.width = "100%";
                            progressBar.textContent = "100%";
                            progressBar.classList.remove('progress-bar-animated');

                            // NOTE: Chỉ cần cập nhật href và hiển thị nút download đã có sẵn
                            downloadBtn.href = statusData.download_url;
                            downloadBtn.classList.remove('d-none');
                            
                            // NOTE: Kích hoạt lại nút bấm
                            resetButtonState();
                            break;

                        case "FAILURE":
                            statusMessage.textContent = "Có lỗi xảy ra: " + (statusData.error || "Lỗi không xác định.");
                            statusMessage.className = 'text-danger fw-bold';
                            progressBar.classList.add('bg-danger');
                            progressBar.classList.remove('progress-bar-animated');
                            resetButtonState();
                            break;
                            
                        default:
                            // Các trạng thái khác (nếu có)
                            statusMessage.textContent = "Trạng thái: " + statusData.status;
                            setTimeout(() => pollStatus(taskId), 2000);
                            break;
                    }
                })
                .catch(err => {
                    console.error("Lỗi polling:", err);
                    statusMessage.textContent = "Mất kết nối tới server. Vui lòng thử lại.";
                    statusMessage.className = 'text-danger fw-bold';
                    resetButtonState();
                });
        }

        // NOTE: Hàm để trả lại trạng thái ban đầu cho nút Submit
        function resetButtonState() {
            submitBtn.disabled = false;
            btnText.textContent = "Tạo File ZIP";
            btnSpinner.classList.add('d-none');
        }
    </script>
</body>
</html>